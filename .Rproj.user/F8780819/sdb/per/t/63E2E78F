{
    "collab_server" : "",
    "contents" : "######################################################################\n\n#### Pull data together for modelling ####\n\nlibrary(dplyr)\nlibrary(foreach)\nlibrary(DescTools)\nlibrary(changepoint)\nsource('../bootstrapping_Thayer.R')\n\nwd <- \"D:/Dropbox/BlackBawks/PROJECTS/Farallon/OneThird/Data/\"\n\nsetwd(wd)\n\nGlobaldat <- read.table('./Raw_data.csv', header=T, sep=\",\")\n\n'%!in%' <- function(x,y)!('%in%'(x,y))\n\ngetData <- function(predator,prey){\n  A1 <- data.frame(year = Globaldat$Year, \n                   prd = Globaldat[predator], \n                   pry = Globaldat[prey],\n                   prdname=rep(predator,42),\n                   pryname=rep(prey,42))\n  names(A1) <- c('year','prd','pry','prdname','pryname')\n  return(A1)\n}\n\nbootstrap_size <- 1000\nsmoother_size <- 3\n############################################################################################################\n\n#### First we run the GAMS with mgcv in order to get the EDF values out\n\n# Abundance of I) anchovy prey relative to productivity of \n# a) Brandt’s cormorants at SE Farallon Island (SFI), \n# b) Año Nuevo Island (ANI) and \n# c) Alcatraz Island (ALZ), \n# d) common murre at SFI, \n# e) rhinoceros auklet at SFI and \n# f) ANI, \n# g) brown pelican at Santa Barbara Island (SBI) and \n# h) Anacapa Island (ANA), \n# i) least tern at Venice Beach (VB), and \n# j) California sea lions at San Miguel Island (SMI) \n# k) San Clemente Island (SCI), \n# l) SBI, and \n# m) San Nicolas Island (SNI); \n# \n# II) juvenile rockfish prey relative to productivity of \n# a) common murre at SFI, \n# b) rhinoceros auklet at SFI and \n# c) ANI, \n# d) pelagic cormorant at SFI and \n# e) ANI, \n# f) pigeon guillemot at SFI, and \n# g) Chinook salmon from the Central Valley fall run (CV). \n# \n# III) sardine prey relative to \n# a) productivity of sea lions at (SMI) and \n# b) Chinook salmon from CV; and \n# \n# IV) market squid prey relative to productivity of \n# a) common murre at SFI, \n# b) rhinoceros auklet at SFI and \n# c) ANI, and \n# d) sea lions at SMI.\n\n\n\ndetach(\"package:mgcv\", unload=TRUE)\nlibrary(gam)\nsmoother_size=2\n\n\nIa <- getData('BRAC.SFI','anchovy.biomass')\nIb <- getData('BRAC.ANI','anchovy.biomass')\nIc <- getData('BRAC.ALZ','anchovy.biomass')\nId <- getData('COMU.SFI','anchovy.biomass')\nIe <- getData('RHAU.SFI','anchovy.biomass')\nIf <- getData('RHAU.ANI','anchovy.biomass')\nIg <- getData('BRPE.SBI','anchovy.biomass')\nIh <- getData('BRPE.ANA','anchovy.biomass')\nIi <- getData('LETE.VB','anchovy.biomass')\nIj <- getData('CASL.SMI','anchovy.biomass')\nIk <- getData('CASL.SCI','anchovy.biomass')\nIl <- getData('CASL_SBI','anchovy.biomass')\nIm <- getData('CASL.SNI','anchovy.biomass')\n\nIIa <- getData('COMU.SFI','rockfish.jrssurvey')\nIIb <- getData('RHAU.SFI','rockfish.jrssurvey')\nIIc <- getData('RHAU.ANI','rockfish.jrssurvey')\nIId <- getData('PECO.SFI','rockfish.jrssurvey')\nIIe <- getData('PECO.ANI','rockfish.jrssurvey')\nIIf <- getData('PIGU.SFI','rockfish.jrssurvey')\nIIg <- getData('SALM.SAC','rockfish.jrssurvey')\n\nIIIa <- getData('CASL.SMI','sardine.ichthyo')\nIIIb <- getData('SALM.SAC','sardine.ichthyo')\nIIIc <- getData('BRPE.SBI','sardine.ichthyo')\nIIId <- getData('BRPE.ANA','sardine.ichthyo')\nIIIe <- getData('CASL.SCI','sardine.ichthyo')\nIIIf <- getData('CASL_SBI','sardine.ichthyo')\nIIIg <- getData('CASL.SNI','sardine.ichthyo')\n\n\nIVa <- getData('COMU.SFI','squid.ichthyo')\nIVb <- getData('RHAU.SFI','squid.ichthyo')\nIVc <- getData('RHAU.ANI','squid.ichthyo')\nIVd <- getData('CASL.SMI','squid.ichthyo')\nIVe <- getData('CASL.SCI','squid.ichthyo')\nIVf <- getData('CASL_SBI','squid.ichthyo')\nIVg <- getData('CASL.SNI','squid.ichthyo')\n\n\n##### Seabirds, Sealions, Salmon (by prey)\n## seabirds\n\nsbrds <- list(Ia,Ib,Ic,Id,Ie,If,Ig,Ih,Ii,IIa,IIb,IIc,IId,IIe,IIf,IIIc,IIId,IVa,IVb,IVc)\nseabirds <- do.call('rbind',sbrds)\n\nt_glob <- seabirds\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$pryname == 'anchovy.biomass')] <- 'black'\nt_glob$colour[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'red'\nt_glob$colour[which(t_glob$pryname == 'sardine.ichthyo')] <- 'blue'\nt_glob$colour[which(t_glob$pryname == 'squid.ichthyo')] <- 'green'\n\nt_glob$legend[which(t_glob$pryname == 'anchovy.biomass')] <- 'anchovy'\nt_glob$legend[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'rockfish'\nt_glob$legend[which(t_glob$pryname == 'sardine.ichthyo')] <- 'sardine'\nt_glob$legend[which(t_glob$pryname == 'squid.ichthyo')] <- 'squid'\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'seabirds.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n\n## sealions\n\nselins <- list(Ij,Ik,Il,Im,IIIa,IIIe,IIIf,IIIg,IVd,IVe,IVf,IVg)\nsealions <- do.call('rbind',selins)\nt_glob <- sealions\n## remove rockfish...\nt_glob <- tbl_df(sealions) %>% filter(pryname != 'rockfish.jrssurvey')\nt_glob <- data.frame(t_glob)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$pryname == 'anchovy.biomass')] <- 'black'\nt_glob$colour[which(t_glob$pryname == 'sardine.ichthyo')] <- 'blue'\nt_glob$colour[which(t_glob$pryname == 'squid.ichthyo')] <- 'green'\n\nt_glob$legend[which(t_glob$pryname == 'anchovy.biomass')] <- 'anchovy'\nt_glob$legend[which(t_glob$pryname == 'sardine.ichthyo')] <- 'sardine'\nt_glob$legend[which(t_glob$pryname == 'squid.ichthyo')] <- 'squid'\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'sealions.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n\n\n\n\n\n### Salmon\n\nsalms <- list(IIg,IIIb)\nsalmon <- do.call('rbind',salms)\nt_glob <- tbl_df(salmon) %>% filter(!pryname %in% c('squid.jrssurvey','anchovy.biomass'))\nt_glob <- data.frame(t_glob)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'red'\nt_glob$colour[which(t_glob$pryname == 'sardine.ichthyo')] <- 'blue'\n\nt_glob$legend[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'rockfish'\nt_glob$legend[which(t_glob$pryname == 'sardine.ichthyo')] <- 'sardine'\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'salmon.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,plotlines=FALSE,pntsize=2)\n\n\n################################################################################################################\n\n### Anchovy\nacns <- list(Ia,Ib,Ic,Id,Ie,If,Ig,Ih,Ii,Ij,Ik,Il,Im)\nanchovy <- do.call('rbind',acns)\n\nt_glob <- data.frame(anchovy)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$prdname %in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'red'\nt_glob$colour[which(t_glob$prdname %!in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'black'\n  \nt_glob$legend[which(t_glob$prdname %in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'sealions'\nt_glob$legend[which(t_glob$prdname %!in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'seabirds'\n  \n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'anchovy.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n\n\n\n\n### Rockfish\nrcfs <- list(IIa,IIb,IIc,IId,IIe,IIf,IIg)\nrockfish <- do.call('rbind',rcfs)\n\nt_glob <- data.frame(rockfish)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$prdname %in% c('SALM.SAC'))] <- 'green'\nt_glob$colour[which(t_glob$prdname %!in% c('SALM.SAC'))] <- 'black'\n\nt_glob$legend[which(t_glob$prdname %in% c('SALM.SAC'))] <- 'salmon'\nt_glob$legend[which(t_glob$prdname %!in% c('SALM.SAC'))] <- 'seabirds'\n\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'rockfish.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n\n\n\n### Sardine\nsrds <- list(IIIa,IIIb,IIIc,IIId,IIIe,IIIf,IIIg)\nsardine <- do.call('rbind',srds)\n\nt_glob <- data.frame(sardine)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$prdname %in% c('SALM.SAC'))] <- 'green'\nt_glob$colour[which(t_glob$prdname %in% c('BRPE.SBI','BRPE.ANA'))] <- 'black'\nt_glob$colour[which(t_glob$prdname %in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'red'\n\nt_glob$legend[which(t_glob$prdname %in% c('SALM.SAC'))] <- 'salmon'\nt_glob$legend[which(t_glob$prdname %in% c('BRPE.SBI','BRPE.ANA'))] <- 'seabirds'\nt_glob$legend[which(t_glob$prdname %in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'sealions'\n\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'sardine.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,plotlines=FALSE,pntsize=2)\n\n\n\n\n### Squid\nsqds <- list(IVa,IVb,IVc,IVd,IVe,IVf,IVg)\nsquid <- do.call('rbind',sqds)\nt_glob <- data.frame(squid)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$prdname %in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'red'\nt_glob$colour[which(t_glob$prdname %!in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'black'\n\nt_glob$legend[which(t_glob$prdname %in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'sealions'\nt_glob$legend[which(t_glob$prdname %!in% c('CASL.SMI','CASL.SCI','CASL_SBI','CASL.SNI'))] <- 'seabirds'\n\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'squid.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n\n\n\n\n#######################################################################################################################\n##### CENCAL\n\n\n\ncencal <- list(Ia,Ib,Ic,Id,Ie,If,Ig,IIa,IIb,IIc,IId,IIe,IIf,IIg,IIIb,IVa,IVb,IVc)\ncen.cal <- do.call('rbind',cencal)\n\nt_glob <- data.frame(cen.cal)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$pryname == 'anchovy.biomass')] <- 'black'\nt_glob$colour[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'red'\nt_glob$colour[which(t_glob$pryname == 'sardine.ichthyo')] <- 'blue'\nt_glob$colour[which(t_glob$pryname == 'squid.ichthyo')] <- 'green'\n\nt_glob$legend[which(t_glob$pryname == 'anchovy.biomass')] <- 'anchovy'\nt_glob$legend[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'rockfish'\nt_glob$legend[which(t_glob$pryname == 'sardine.ichthyo')] <- 'sardine'\nt_glob$legend[which(t_glob$pryname == 'squid.ichthyo')] <- 'squid'\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'centralcal.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n#################\n\n\n\n\nsocal <- list(Ih,Ii,Ij,Ik,Il,Im,IIIa,IIIc,IIId,IIIe,IIIf,IIIg,IVd,IVe,IVf,IVg)\nso.cal <- do.call('rbind',socal)\nt_glob <- data.frame(so.cal)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$pryname == 'anchovy.biomass')] <- 'black'\nt_glob$colour[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'red'\nt_glob$colour[which(t_glob$pryname == 'sardine.ichthyo')] <- 'blue'\nt_glob$colour[which(t_glob$pryname == 'squid.ichthyo')] <- 'green'\n\nt_glob$legend[which(t_glob$pryname == 'anchovy.biomass')] <- 'anchovy'\nt_glob$legend[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'rockfish'\nt_glob$legend[which(t_glob$pryname == 'sardine.ichthyo')] <- 'sardine'\nt_glob$legend[which(t_glob$pryname == 'squid.ichthyo')] <- 'squid'\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'southerncal.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n###########################################################################################################\n\n#### Global ####\n\n\nDATAS <- list(Ia,Ib,Ic,Id,Ie,If,Ig,Ih,Ii,Ij,Ik,Il,Im,IIa,IIb,IIc,IId,IIe,IIf,IIg,IIIa,IIIb,\n              IIIc,IIId,IIIe,IIIf,IIIg,IVa,IVb,IVc,IVd,IVe,IVf,IVg)\n\nglobal <- do.call('rbind',DATAS)\n\n\nt_glob <- data.frame(global)\nt_glob$colour <- NA\nt_glob$legend <- NA\n\nt_glob$colour[which(t_glob$pryname == 'anchovy.biomass')] <- 'black'\nt_glob$colour[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'red'\nt_glob$colour[which(t_glob$pryname == 'sardine.ichthyo')] <- 'blue'\nt_glob$colour[which(t_glob$pryname == 'squid.ichthyo')] <- 'green'\n\nt_glob$legend[which(t_glob$pryname == 'anchovy.biomass')] <- 'anchovy'\nt_glob$legend[which(t_glob$pryname == 'rockfish.jrssurvey')] <- 'rockfish'\nt_glob$legend[which(t_glob$pryname == 'sardine.ichthyo')] <- 'sardine'\nt_glob$legend[which(t_glob$pryname == 'squid.ichthyo')] <- 'squid'\n\nthresh <- Run.Bootstrap(t_glob)\npNAME <- 'global.png'\n\nout <- plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=TRUE,pntsize=2)\n\n\n\n#################################################################################################################################\n#################################################################################################################################\n#################################################################################################################################\n\n\n\n\n\n\n\n\nDATAS <- list(IIIc,IIId,IIIc2,IIId2)\n\nEDFval <- function(data){\n  data <- data[complete.cases(data),]\n  predator <- data[,2]\n  prey <- data[,3]\n  \n  gam.obj <- gam(predator~s(prey, k=smoother_size))\n  EDF <- sum(gam.obj$edf)\n  \n  pd <- names(data)[2]\n  py <- names(data)[3]\n  \n  M <- data.frame(pd,py,as.character(EDF))\n  names(M) <- c('pred','prey','edf')\n  return(M)\n}\n\n\nOUT <- foreach(x = DATAS, .combine='rbind') %do% {\n  return(EDFval(x))\n}\n\n#write.csv(OUT,'EDFs.csv',row.names=F)\n\n\n\n\n\n\n\nDATAS <- list(Ia,Ib,Ic,Id,Ie,If,Ig,Ih,Ii,Ij,Ik,Il,Im,IIa,IIb,IIc,IId,IIe,IIf,IIg,IIIa,IIIb,\n              IIIc,IIId,IIIe,IIIf,IIIg,IVa,IVb,IVc,IVd)\n\nFIGNAMES <- list(\"Ia\",'Ib','Ic','Id','Ie','If','Ig','Ih','Ii','Ij','Ik','Il','Im',\n                 'IIa','IIb','IIc','IId','IIe','IIf','IIg',\n                 'IIIa','IIIb','IIIc','IIId','IIIe','IIIf','IIIg',\n                 'IVa','IVb','IVc','IVd')\n\n\nDATAS <- list(IVf,IVg)\nFIGNAMES <-list('IVf','IVg')\n\nfor(i in 1:length(DATAS)){\n  t_glob <- DATAS[[i]]\n  t_glob$colour <- 'black'\n  thresh <- Run.Bootstrap(t_glob)\n  \n  pNAME <- paste(FIGNAMES[i],'.png',sep='')\n  \n  \n  data <- t_glob[complete.cases(t_glob),]\n  predator <- data[,2]\n  prey <- data[,3]\n  \n  gam.obj <- gam(predator~s(prey, k=smoother_size))\n  EDF <- sum(gam.obj$edf)\n  if(round(EDF,4) > 2){\n    print(pNAME)\n    plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=FALSE,pntsize=2)  \n  }else{\n    print(pNAME)\n    plotdata(t_glob,pNAME,pngfigure=1,smoother_size=3,labs=FALSE,pntsize=2,plotlines=FALSE)  \n  }\n  \n  \n    \n}\n\n\n\n\n\n\n\n\n\n\n\n",
    "created" : 1526641481209.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "498210466",
    "id" : "63E2E78F",
    "lastKnownWriteTime" : 1526646920,
    "last_content_update" : -2147483648,
    "path" : "D:/Dropbox/BlackBawks/PROJECTS/Farallon/OneThird/MasterCode2.R",
    "project_path" : "MasterCode2.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}